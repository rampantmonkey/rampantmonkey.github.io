<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Korean Vocabulary Learning</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: white;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .container {
            width: 100vw;
            height: 100vh;
            height: -webkit-fill-available;
            margin: 0;
            background: rgba(255,255,255,0.1);
            padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 100px) env(safe-area-inset-left, 20px);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .mode-selector {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 25px;
            padding: 4px;
            backdrop-filter: blur(20px);
            z-index: 200;
            gap: 4px;
        }
        
        .vocab-selector {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 8px;
            backdrop-filter: blur(20px);
            z-index: 199;
        }
        
        .vocab-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .vocab-select option {
            background: #333;
            color: white;
        }
        
        .mode-button {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            font-weight: 500;
        }
        
        .mode-button.active {
            background: rgba(255,255,255,0.2);
            opacity: 1;
            transform: scale(1.05);
        }
        
        .word-counter {
            text-align: center;
            margin: 10px 0 20px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 12px 16px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .korean {
            font-size: 3rem;
            text-align: center;
            margin: 16px 0;
            font-weight: 300;
            letter-spacing: 0.05em;
            line-height: 1.2;
            position: relative;
        }
        
        .syllable {
            display: inline-block;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 4px;
            margin: 2px;
            border-radius: 8px;
            min-width: 44px;
            min-height: 44px;
            align-items: center;
            justify-content: center;
        }
        
        .syllable.active {
            animation: syllablePulse 0.6s ease-out;
        }
        
        @keyframes syllablePulse {
            0% { 
                transform: translateY(0) scale(1);
                color: white;
            }
            50% { 
                transform: translateY(-12px) scale(1.1);
                color: #ffd700;
                text-shadow: 0 0 25px rgba(255,215,0,0.8);
            }
            100% { 
                transform: translateY(0) scale(1);
                color: white;
            }
        }
        
        .bouncing-ball {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ffd700;
            border-radius: 50%;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
            z-index: 10;
        }
        
        .bouncing-ball.animate {
            opacity: 1;
            animation: bounce 0.6s ease-in-out;
        }
        
        @keyframes bounce {
            0% { transform: translateX(-50%) translateY(-10px); }
            50% { transform: translateX(-50%) translateY(10px) scale(1.2); }
            100% { transform: translateX(-50%) translateY(-10px); }
        }
        
        .definition {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 20px 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .english {
            font-size: 1.6rem;
            margin-bottom: 12px;
            font-weight: 500;
            line-height: 1.3;
        }
        
        .romanization {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-top: 8px;
            font-style: italic;
        }
        
        .input-area {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 20px 16px;
            margin: 16px 0;
            text-align: center;
            display: none;
        }
        
        .input-field {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 12px 16px;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            width: 100%;
            max-width: 300px;
            outline: none;
            font-family: inherit;
        }
        
        .input-field::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .input-field:focus {
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255,215,0,0.3);
        }
        
        .feedback {
            margin-top: 12px;
            font-size: 1rem;
            font-weight: 500;
            min-height: 24px;
        }
        
        .feedback.correct {
            color: #4ade80;
        }
        
        .feedback.incorrect {
            color: #f87171;
        }
        
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px env(safe-area-inset-right, 16px) calc(16px + env(safe-area-inset-bottom, 0px)) env(safe-area-inset-left, 16px);
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 12px;
            justify-content: center;
            z-index: 100;
        }
        
        button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 16px 24px;
            border-radius: 28px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            min-height: 56px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }
        
        @media (hover: hover) {
            button:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-2px);
            }
        }
        
        button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.4);
        }
        
        .loading {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.7;
            padding: 40px 0;
        }
        
        @media screen and (max-width: 430px) {
            .korean {
                font-size: 2.5rem;
                margin: 12px 0;
            }
            
            .controls {
                gap: 8px;
                padding: 12px 12px calc(12px + env(safe-area-inset-bottom, 0px));
            }
            
            button {
                padding: 14px 16px;
                font-size: 0.9rem;
                border-radius: 24px;
            }
            
            .mode-selector {
                top: env(safe-area-inset-top, 10px);
            }
            
            .mode-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .vocab-selector {
                top: calc(env(safe-area-inset-top, 10px) + 50px);
            }
        }
    </style>
</head>
<body>
    <div class="mode-selector">
        <button class="mode-button active" onclick="setMode('present')">Present</button>
        <button class="mode-button" onclick="setMode('hangul')">Enter Hangul</button>
        <button class="mode-button" onclick="setMode('english')">Enter English</button>
    </div>
    
    <div class="vocab-selector">
        <select class="vocab-select" id="vocabSelect" onchange="changeVocabSet()">
            <option value="0">Loading vocabulary...</option>
        </select>
    </div>
    
    <div class="container">
        <div id="loadingDiv" class="loading">Loading Korean vocabulary...</div>
        
        <div id="appDiv" style="display: none">
            <div class="word-counter">
                <span id="wordCounter">Word 1 of ---</span>
            </div>
            
            <!-- Present Mode -->
            <div id="presentMode" class="mode-content">
                <div class="korean" id="korean">
                    <div class="bouncing-ball" id="ball"></div>
                </div>
                
                <div class="definition">
                    <div class="english" id="english"></div>
                    <div class="romanization" id="romanization"></div>
                </div>
            </div>
            
            <!-- Enter Hangul Mode -->
            <div id="hangulMode" class="mode-content" style="display: none">
                <div class="definition">
                    <div class="english" id="englishPrompt"></div>
                </div>
                
                <div class="input-area" style="display: block">
                    <input type="text" class="input-field" id="hangulInput" placeholder="ÌïúÍµ≠Ïñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" autocomplete="off">
                    <div class="feedback" id="hangulFeedback"></div>
                </div>
                
                <div class="korean" id="hangulAnswer" style="display: none">
                    <div class="bouncing-ball" id="hangulBall"></div>
                </div>
            </div>
            
            <!-- Enter English Mode -->
            <div id="englishMode" class="mode-content" style="display: none">
                <div class="korean" id="englishModeKorean">
                    <div class="bouncing-ball" id="englishBall"></div>
                </div>
                
                <div class="input-area" style="display: block">
                    <input type="text" class="input-field" id="englishInput" placeholder="Enter English translation" autocomplete="off">
                    <div class="feedback" id="englishFeedback"></div>
                </div>
                
                <div class="definition" id="englishAnswer" style="display: none">
                    <div class="english" id="englishCorrectAnswer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="playAudio()">üîä Play</button>
        <button onclick="playSlowAudio()">üêå Slow</button>
        <button onclick="nextWord()">‚û°Ô∏è Next</button>
    </div>

    <script>
        // Korean syllable timing lookup table for animation
        const koreanDurations = {
            'Í∞Ä': 110, 'ÎÇò': 100, 'Îã§': 105, 'Îùº': 95, 'Îßà': 105,
            'Î∞î': 100, 'ÏÇ¨': 95, 'ÏïÑ': 120, 'Ïûê': 100, 'Ï∞®': 105,
            'Ïπ¥': 100, 'ÌÉÄ': 105, 'Ìåå': 100, 'Ìïò': 105,
            'Í±∞': 105, 'ÎÑà': 95, 'Îçî': 100, 'Îü¨': 90, 'Î®∏': 100,
            'Î≤Ñ': 95, 'ÏÑú': 90, 'Ïñ¥': 115, 'Ï†Ä': 95, 'Ï≤ò': 100,
            'Ïª§': 95, 'ÌÑ∞': 100, 'Ìçº': 95, 'Ìóà': 100,
            'Í≥†': 110, 'ÎÖ∏': 100, 'ÎèÑ': 105, 'Î°ú': 95, 'Î™®': 105,
            'Î≥¥': 100, 'ÏÜå': 95, 'Ïò§': 115, 'Ï°∞': 100, 'Ï¥à': 105,
            'ÏΩî': 100, 'ÌÜ†': 105, 'Ìè¨': 100, 'Ìò∏': 105,
            'Íµ¨': 105, 'ÎàÑ': 95, 'Îëê': 100, 'Î£®': 90, 'Î¨¥': 100,
            'Î∂Ä': 95, 'Ïàò': 90, 'Ïö∞': 115, 'Ï£º': 95, 'Ï∂î': 100,
            'Ïø†': 95, 'Ìà¨': 100, 'Ìë∏': 95, 'ÌõÑ': 100,
            'Í∑∏': 100, 'Îäê': 95, 'Îìú': 100, 'Î•¥': 90, 'ÎØÄ': 95,
            'Î∏å': 90, 'Ïä§': 85, 'Ïúº': 110, 'Ï¶à': 90, 'Ï∏†': 95,
            'ÌÅ¨': 90, 'Ìä∏': 95, 'ÌîÑ': 90, 'Ìùê': 95,
            'Í∏∞': 95, 'Îãà': 85, 'Îîî': 90, 'Î¶¨': 80, 'ÎØ∏': 90,
            'ÎπÑ': 85, 'Ïãú': 80, 'Ïù¥': 105, 'ÏßÄ': 85, 'Ïπò': 90,
            'ÌÇ§': 85, 'Ìã∞': 90, 'Ìîº': 85, 'Ìûà': 90
        };

        function predictKoreanTiming(korean, rate = 1.0) {
            const syllables = korean.split('');
            const durations = syllables.map((syllable, index) => {
                let duration = koreanDurations[syllable] || 100;
                
                if (index === 0) duration *= 1.1;
                if (index === syllables.length - 1) duration *= 1.2;
                
                duration = duration / Math.pow(rate, 0.8);
                
                return Math.round(duration);
            });

            let currentTime = 0;
            const timings = durations.map((duration, index) => {
                const timing = {
                    syllable: syllables[index],
                    startTime: currentTime,
                    duration: duration
                };
                currentTime += duration;
                return timing;
            });

            return {
                totalDuration: currentTime,
                timings: timings
            };
        }

        // Simple Korean romanization lookup table
        const romanizationMap = {
            'Í∞Ä': 'ga', 'ÎÇò': 'na', 'Îã§': 'da', 'Îùº': 'ra', 'Îßà': 'ma',
            'Î∞î': 'ba', 'ÏÇ¨': 'sa', 'ÏïÑ': 'a', 'Ïûê': 'ja', 'Ï∞®': 'cha',
            'Ïπ¥': 'ka', 'ÌÉÄ': 'ta', 'Ìåå': 'pa', 'Ìïò': 'ha',
            'Í±∞': 'geo', 'ÎÑà': 'neo', 'Îçî': 'deo', 'Îü¨': 'reo', 'Î®∏': 'meo',
            'Î≤Ñ': 'beo', 'ÏÑú': 'seo', 'Ïñ¥': 'eo', 'Ï†Ä': 'jeo', 'Ï≤ò': 'cheo',
            'Ïª§': 'keo', 'ÌÑ∞': 'teo', 'Ìçº': 'peo', 'Ìóà': 'heo',
            'Í≥†': 'go', 'ÎÖ∏': 'no', 'ÎèÑ': 'do', 'Î°ú': 'ro', 'Î™®': 'mo',
            'Î≥¥': 'bo', 'ÏÜå': 'so', 'Ïò§': 'o', 'Ï°∞': 'jo', 'Ï¥à': 'cho',
            'ÏΩî': 'ko', 'ÌÜ†': 'to', 'Ìè¨': 'po', 'Ìò∏': 'ho',
            'Íµ¨': 'gu', 'ÎàÑ': 'nu', 'Îëê': 'du', 'Î£®': 'ru', 'Î¨¥': 'mu',
            'Î∂Ä': 'bu', 'Ïàò': 'su', 'Ïö∞': 'u', 'Ï£º': 'ju', 'Ï∂î': 'chu',
            'Ïø†': 'ku', 'Ìà¨': 'tu', 'Ìë∏': 'pu', 'ÌõÑ': 'hu',
            'Í∑∏': 'geu', 'Îäê': 'neu', 'Îìú': 'deu', 'Î•¥': 'reu', 'ÎØÄ': 'meu',
            'Î∏å': 'beu', 'Ïä§': 'seu', 'Ïúº': 'eu', 'Ï¶à': 'jeu', 'Ï∏†': 'cheu',
            'ÌÅ¨': 'keu', 'Ìä∏': 'teu', 'ÌîÑ': 'peu', 'Ìùê': 'heu',
            'Í∏∞': 'gi', 'Îãà': 'ni', 'Îîî': 'di', 'Î¶¨': 'ri', 'ÎØ∏': 'mi',
            'ÎπÑ': 'bi', 'Ïãú': 'si', 'Ïù¥': 'i', 'ÏßÄ': 'ji', 'Ïπò': 'chi',
            'ÌÇ§': 'ki', 'Ìã∞': 'ti', 'Ìîº': 'pi', 'Ìûà': 'hi',
            
            // Common words
            'Ïïà': 'an', 'ÎÖï': 'nyeong', 'ÏÑ∏': 'se', 'Ïöî': 'yo',
            'Í∞ê': 'gam', 'Ìï©': 'hap', 'Îã§': 'da',
            'Î¨º': 'mul', 'Î∞•': 'bap', 'Ïßë': 'jip',
            'Ìïô': 'hak', 'Íµê': 'gyo', 'Ïπú': 'chin', 'Íµ¨': 'gu',
            'Î®π': 'meok', 'Îßà': 'ma', 'Ïãú': 'si',
            'Ï¢ã': 'joh', 'Ïûë': 'jak', 'ÌÅ∞': 'keun',
            'Î≠ê': 'mwo', 'Ïôú': 'wae', 'Ïñ¥': 'eo', 'Îîî': 'di',
            'Ïñ∏': 'eon', 'Ï†ú': 'je', 'ÎàÑ': 'nu',
            'Ïñ¥': 'eo', 'Îñª': 'tteoh', 'Í≤å': 'ge',
            'Ïûà': 'iss', 'Ïõê': 'won', 'Îßê': 'mal',
            'Ïïå': 'al', 'ÎÑ§': 'ne', 'ÏïÑ': 'a', 'Îãà': 'ni',
            'Ï£º': 'ju', 'ÏÑ∏': 'se', 'ÏôÄ': 'wa',
            'Í≤É': 'geot', 'Ïù¥': 'i', 'Ï†Ä': 'jeo',
            'Ïó¨': 'yeo', 'Í∏∞': 'gi', 'Îì§': 'deul'
        };

        function getRomanization(korean) {
            const syllables = korean.split('');
            const romanized = syllables.map(syllable => {
                return romanizationMap[syllable] || syllable;
            });
            return romanized.join('-');
        }

        // Vocabulary sets with embedded data
        const vocabularySets = {
            'first-30': {
                name: 'First 30 Essential Words',
                description: 'The most essential Korean words for beginners',
                words: [
                    {"english": "I", "korean": "ÎÇò"},
                    {"english": "You (informal)", "korean": "ÎÑà"},
                    {"english": "We", "korean": "Ïö∞Î¶¨"},
                    {"english": "What", "korean": "Î≠ê"},
                    {"english": "Why", "korean": "Ïôú"},
                    {"english": "Where", "korean": "Ïñ¥Îîî"},
                    {"english": "When", "korean": "Ïñ∏Ï†ú"},
                    {"english": "Who", "korean": "ÎàÑÍµ¨"},
                    {"english": "How", "korean": "Ïñ¥ÎñªÍ≤å"},
                    {"english": "To be", "korean": "Ïù¥Îã§"},
                    {"english": "To have/exist", "korean": "ÏûàÎã§"},
                    {"english": "To do", "korean": "ÌïòÎã§"},
                    {"english": "To go", "korean": "Í∞ÄÎã§"},
                    {"english": "They", "korean": "Í∑∏Îì§"},
                    {"english": "To want", "korean": "ÏõêÌïòÎã§"},
                    {"english": "To eat", "korean": "Î®πÎã§"},
                    {"english": "To drink", "korean": "ÎßàÏãúÎã§"},
                    {"english": "To speak", "korean": "ÎßêÌïòÎã§"},
                    {"english": "To know/understand", "korean": "ÏïåÎã§"},
                    {"english": "Yes", "korean": "ÎÑ§"},
                    {"english": "No", "korean": "ÏïÑÎãàÏöî"},
                    {"english": "Please (when requesting)", "korean": "Ï£ºÏÑ∏Ïöî"},
                    {"english": "Thank you", "korean": "Í∞êÏÇ¨Ìï©ÎãàÎã§"},
                    {"english": "Hello", "korean": "ÏïàÎÖïÌïòÏÑ∏Ïöî"},
                    {"english": "Goodbye", "korean": "ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî"},
                    {"english": "This", "korean": "Ïù¥Í≤É"},
                    {"english": "That", "korean": "Ï†ÄÍ≤É"},
                    {"english": "Here", "korean": "Ïó¨Í∏∞"},
                    {"english": "There", "korean": "Ï†ÄÍ∏∞"}
                ]
            },
            'starter': {
                name: 'Starter Vocabulary',
                description: 'Extended vocabulary for daily conversations',
                words: [
                    {"korean": "ÏïàÎÖïÌïòÏÑ∏Ïöî", "english": "Hello (formal)"},
                    {"korean": "Í∞êÏÇ¨Ìï©ÎãàÎã§", "english": "Thank you"},
                    {"korean": "Ï£ÑÏÜ°Ìï©ÎãàÎã§", "english": "I'm sorry"},
                    {"korean": "Î¨º", "english": "water"},
                    {"korean": "Î∞•", "english": "rice/meal"},
                    {"korean": "Ïßë", "english": "house"},
                    {"korean": "ÌïôÍµê", "english": "school"},
                    {"korean": "ÏπúÍµ¨", "english": "friend"},
                    {"korean": "Í∞ÄÎã§", "english": "to go"},
                    {"korean": "Ïò§Îã§", "english": "to come"},
                    {"korean": "Î®πÎã§", "english": "to eat"},
                    {"korean": "ÎßàÏãúÎã§", "english": "to drink"},
                    {"korean": "Ï¢ãÎã§", "english": "to be good"},
                    {"korean": "ÌÅ¨Îã§", "english": "to be big"},
                    {"korean": "ÏûëÎã§", "english": "to be small"},
                    {"korean": "ÏÉà", "english": "bird"},
                    {"korean": "Í≥†ÏñëÏù¥", "english": "cat"},
                    {"korean": "Í∞ú", "english": "dog"},
                    {"korean": "Ï±Ö", "english": "book"},
                    {"korean": "Ïó∞ÌïÑ", "english": "pencil"},
                    {"korean": "ÏÇ¨Îûå", "english": "person"},
                    {"korean": "ÏïÑÏù¥", "english": "child"},
                    {"korean": "ÏóÑÎßà", "english": "mom"},
                    {"korean": "ÏïÑÎπ†", "english": "dad"},
                    {"korean": "ÏÑ†ÏÉùÎãò", "english": "teacher"},
                    {"korean": "ÌïôÏÉù", "english": "student"},
                    {"korean": "ÏùòÏÇ¨", "english": "doctor"},
                    {"korean": "Í∞ÑÌò∏ÏÇ¨", "english": "nurse"},
                    {"korean": "ÏùåÏãù", "english": "food"},
                    {"korean": "Ï∞®", "english": "tea/car"}
                ]
            }
        };

        // App state
        let currentWordIndex = 0;
        let totalWordCount = 0;
        let currentWord = null;
        let currentMode = 'present';
        let loadedKoreanVoice = null;
        let currentVocabSet = 'first-30';

        // Vocabulary data is now embedded directly in the code above
        function initVocabularyData() {
            console.log('‚úÖ Using embedded vocabulary data');
            console.log('‚úÖ First-30 vocabulary:', vocabularySets['first-30'].words.length, 'words');
            console.log('‚úÖ Starter vocabulary:', vocabularySets['starter'].words.length, 'words');
            return true;
        }

        function populateVocabSelector() {
            const select = document.getElementById('vocabSelect');
            select.innerHTML = '';
            
            Object.keys(vocabularySets).forEach(key => {
                const set = vocabularySets[key];
                if (set.words.length > 0) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${set.name} (${set.words.length} words)`;
                    select.appendChild(option);
                }
            });
            
            select.value = currentVocabSet;
            console.log('‚úÖ Vocabulary selector populated');
        }

        function changeVocabSet() {
            const select = document.getElementById('vocabSelect');
            const newSet = select.value;
            
            if (vocabularySets[newSet] && vocabularySets[newSet].words.length > 0) {
                currentVocabSet = newSet;
                currentWordIndex = 0;
                totalWordCount = vocabularySets[newSet].words.length;
                currentWord = vocabularySets[newSet].words[0];
                
                resetModeState();
                updateDisplay();
                
                console.log(`üìö Switched to: ${vocabularySets[newSet].name} (${totalWordCount} words)`);
            }
        }

        function getCurrentVocabulary() {
            return vocabularySets[currentVocabSet]?.words || [];
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-button[onclick="setMode('${mode}')"]`).classList.add('active');
            
            // Show/hide appropriate content
            document.querySelectorAll('.mode-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${mode}Mode`).style.display = 'block';
            
            // Reset current mode state
            resetModeState();
            
            // Update display for current word
            updateDisplay();
        }

        function resetModeState() {
            // Clear input fields
            document.getElementById('hangulInput').value = '';
            document.getElementById('englishInput').value = '';
            
            // Clear feedback
            document.getElementById('hangulFeedback').textContent = '';
            document.getElementById('englishFeedback').textContent = '';
            document.getElementById('hangulFeedback').className = 'feedback';
            document.getElementById('englishFeedback').className = 'feedback';
            
            // Hide answer reveals
            document.getElementById('hangulAnswer').style.display = 'none';
            document.getElementById('englishAnswer').style.display = 'none';
        }

        function updateDisplay() {
            if (!currentWord) return;
            
            // Update word counter
            document.getElementById('wordCounter').textContent = `Word ${currentWordIndex + 1} of ${totalWordCount}`;
            
            switch(currentMode) {
                case 'present':
                    updatePresentMode();
                    break;
                case 'hangul':
                    updateHangulMode();
                    break;
                case 'english':
                    updateEnglishMode();
                    break;
            }
        }

        function updatePresentMode() {
            // Update Korean text with syllable spans
            const koreanEl = document.getElementById('korean');
            koreanEl.innerHTML = '<div class="bouncing-ball" id="ball"></div>' +
                currentWord.korean.split('').map((char, i) => 
                    `<span class="syllable" data-index="${i}" onclick="animateSyllable(${i})">${char}</span>`
                ).join('');
            
            // Update English definition
            document.getElementById('english').textContent = currentWord.english;
            
            // Update romanization
            document.getElementById('romanization').textContent = getRomanization(currentWord.korean);
        }

        function updateHangulMode() {
            document.getElementById('englishPrompt').textContent = currentWord.english;
        }

        function updateEnglishMode() {
            const koreanEl = document.getElementById('englishModeKorean');
            koreanEl.innerHTML = '<div class="bouncing-ball" id="englishBall"></div>' +
                currentWord.korean.split('').map((char, i) => 
                    `<span class="syllable" data-index="${i}">${char}</span>`
                ).join('');
        }

        function animateSyllable(index, ballId = 'ball') {
            document.querySelectorAll('.syllable').forEach(s => s.classList.remove('active'));
            
            const syllable = document.querySelector(`.syllable[data-index="${index}"]`);
            if (syllable) {
                syllable.classList.add('active');
                
                const ball = document.getElementById(ballId);
                const rect = syllable.getBoundingClientRect();
                const containerRect = syllable.parentElement.getBoundingClientRect();
                const ballPos = rect.left - containerRect.left + rect.width / 2;
                
                ball.style.left = `${ballPos}px`;
                ball.classList.remove('animate');
                setTimeout(() => ball.classList.add('animate'), 10);
                
                setTimeout(() => syllable.classList.remove('active'), 600);
            }
        }

        function preloadKoreanVoice() {
            const voices = speechSynthesis.getVoices();
            loadedKoreanVoice = voices.find(voice => voice.lang.startsWith('ko')) || voices[0];
        }

        function playAudio(slow = false) {
            if (!currentWord) return;
            
            const rate = slow ? 0.5 : 1.0;
            const timing = predictKoreanTiming(currentWord.korean, rate);
            
            const utterance = new SpeechSynthesisUtterance(currentWord.korean);
            utterance.lang = 'ko-KR';
            utterance.rate = rate;
            utterance.volume = 1.0;
            
            if (loadedKoreanVoice) {
                utterance.voice = loadedKoreanVoice;
            }
            
            let animationStartTime;
            let syllableIndex = 0;
            let animationId;
            
            const animateWithPredictedTiming = () => {
                const now = Date.now();
                const elapsedTime = now - animationStartTime;
                
                timing.timings.forEach((syllableTiming, index) => {
                    if (elapsedTime >= syllableTiming.startTime && index >= syllableIndex) {
                        const ballId = currentMode === 'english' ? 'englishBall' : (currentMode === 'hangul' ? 'hangulBall' : 'ball');
                        animateSyllable(index, ballId);
                        syllableIndex = index + 1;
                    }
                });
                
                if (syllableIndex < timing.timings.length) {
                    animationId = requestAnimationFrame(animateWithPredictedTiming);
                }
            };
            
            utterance.onstart = () => {
                animationStartTime = Date.now();
                animationId = requestAnimationFrame(animateWithPredictedTiming);
            };
            
            utterance.onend = () => {
                if (animationId) cancelAnimationFrame(animationId);
            };
            
            speechSynthesis.speak(utterance);
        }

        function playSlowAudio() {
            playAudio(true);
        }

        function nextWord() {
            const vocabulary = getCurrentVocabulary();
            currentWordIndex = (currentWordIndex + 1) % vocabulary.length;
            currentWord = vocabulary[currentWordIndex];
            resetModeState();
            updateDisplay();
        }

        // Input handling for learning modes
        document.getElementById('hangulInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkHangulAnswer();
            }
        });

        document.getElementById('englishInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkEnglishAnswer();
            }
        });

        function checkHangulAnswer() {
            const input = document.getElementById('hangulInput').value.trim();
            const feedback = document.getElementById('hangulFeedback');
            
            if (input === currentWord.korean) {
                feedback.textContent = 'Ï†ïÎãµ! Correct!';
                feedback.className = 'feedback correct';
                
                // Show the Korean answer with animation capability
                const answerEl = document.getElementById('hangulAnswer');
                answerEl.innerHTML = '<div class="bouncing-ball" id="hangulBall"></div>' +
                    currentWord.korean.split('').map((char, i) => 
                        `<span class="syllable" data-index="${i}">${char}</span>`
                    ).join('');
                answerEl.style.display = 'block';
            } else {
                feedback.textContent = `Try again! The answer is: ${currentWord.korean}`;
                feedback.className = 'feedback incorrect';
            }
        }

        function checkEnglishAnswer() {
            const input = document.getElementById('englishInput').value.trim().toLowerCase();
            const correct = currentWord.english.toLowerCase();
            const feedback = document.getElementById('englishFeedback');
            
            if (input === correct || currentWord.english.toLowerCase().includes(input)) {
                feedback.textContent = 'Correct!';
                feedback.className = 'feedback correct';
                
                document.getElementById('englishCorrectAnswer').textContent = currentWord.english;
                document.getElementById('englishAnswer').style.display = 'block';
            } else {
                feedback.textContent = `Try again! The answer is: ${currentWord.english}`;
                feedback.className = 'feedback incorrect';
            }
        }

        // Initialize app
        function initApp() {
            console.log('üöÄ Starting Korean vocabulary app...');
            
            // Initialize embedded vocabulary data
            const dataLoaded = initVocabularyData();
            
            if (dataLoaded && vocabularySets[currentVocabSet].words.length > 0) {
                // Populate vocabulary selector
                populateVocabSelector();
                
                // Initialize current word
                totalWordCount = vocabularySets[currentVocabSet].words.length;
                currentWord = vocabularySets[currentVocabSet].words[0];
                
                console.log('‚úÖ Vocabulary loaded:', totalWordCount, 'words');
            } else {
                console.log('‚ùå No vocabulary data available');
                document.querySelector('.vocab-selector').style.display = 'none';
            }
            
            // Load Korean voices
            speechSynthesis.onvoiceschanged = preloadKoreanVoice;
            preloadKoreanVoice();
            
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('appDiv').style.display = 'block';
            
            updateDisplay();
            
            console.log('‚úÖ Korean vocabulary app loaded successfully');
        }

        // Start the app
        initApp();
    </script>
</body>
</html>