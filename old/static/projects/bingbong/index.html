<!doctype html>
  <style>
  body {
    background: #2b2b2b;
    font: 130%/198% sans-serif;
    color: #f6f6f6;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  .half {
    width: 50%;
    float: left;
  }

  .full { width: 100%; }
  #intro p { clear: both; margin: 0.3em; }
  #intro { margin: 1em; }

  textarea {
      width: 98%;
      padding: 0.3em 0;
      border: 0;
      margin: 0;
      height: 15em;
      background: #f6f6f6;
  }

  svg {
      width: 98%;
      height: 10em;
      background-color: #f6f6f6;
  }
  </style>

  <section id="intro" class="full">
    <h1>Bing/Bong</h1>
    <h2>Human interpretable binary encoding</h2>
    <p>Try entering <code>.</code> or <code>-</code></p>
  </section>
  <section id="input" class="half">
    <h1>Input</h1>
    <textarea id="renderSource"></textarea>
  </section>
  <section id="output" class="half">
    <h1>Output</h1>
    <svg id="renderTarget" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
  </section>

  <script>
    var svgNS = "http://www.w3.org/2000/svg"

    window.addEventListener("load", function() {
      var vertexRadius = 10
      var pointRadius = 2
      var vertexSpacing = vertexRadius * 4

      var vertexPositionX = function(row, column) { return vertexRadius * 1.5 + column * vertexSpacing; }
      var vertexPositionY = function(row, column) { return vertexRadius * 1.5 + row * vertexSpacing; }
      var vertexPositionXTop = function(row, column) { return vertexPositionX(row, column); }
      var vertexPositionXLeft = function(row, column) { return vertexPositionX(row, column) - vertexRadius/2; }
      var vertexPositionXRight = function(row, column) { return vertexPositionX(row, column) + vertexRadius/2; }
      var vertexPositionXBottom = function(row, column) { return vertexPositionX(row, column); }
      var vertexPositionYTop = function(row, column) { return vertexPositionY(row, column) - vertexRadius/2; }
      var vertexPositionYLeft = function(row, column) { return vertexPositionY(row, column); }
      var vertexPositionYRight = function(row, column) { return vertexPositionY(row, column); }
      var vertexPositionYBottom = function(row, column) { return vertexPositionY(row, column) + vertexRadius/2; }

      var renderVertex = function(x, y, parentEl) {
        var top = document.createElementNS(svgNS, "circle")
        top.setAttributeNS(null, "cx", x)
        top.setAttributeNS(null, "cy", y - vertexRadius/2)
        top.setAttributeNS(null, "r", pointRadius)
        top.setAttributeNS(null, "fill", "#b6b6b6")
        parentEl.appendChild(top)

        var right = document.createElementNS(svgNS, "circle")
        right.setAttributeNS(null, "cx", x + vertexRadius/2)
        right.setAttributeNS(null, "cy", y)
        right.setAttributeNS(null, "r", pointRadius)
        right.setAttributeNS(null, "fill", "#b6b6b6")
        parentEl.appendChild(right)

        var left = document.createElementNS(svgNS, "circle")
        left.setAttributeNS(null, "cx", x - vertexRadius/2)
        left.setAttributeNS(null, "cy", y)
        left.setAttributeNS(null, "r", pointRadius)
        left.setAttributeNS(null, "fill", "#b6b6b6")
        parentEl.appendChild(left)

        var bot = document.createElementNS(svgNS, "circle")
        bot.setAttributeNS(null, "cx", x)
        bot.setAttributeNS(null, "cy", y + vertexRadius/2)
        bot.setAttributeNS(null, "r", pointRadius)
        bot.setAttributeNS(null, "fill", "#b6b6b6")
        parentEl.appendChild(bot)

      }

      var renderGrid = function(rows, columns, parentId) {
        var parentEl = document.getElementById(parentId)
        if(parentEl == null) { console.log("could not find parent ", parentId); return; }
        for(var i = 0; i < rows; i++) {
          for(var j = 0; j < columns; j++) { // TODO: center this display within the output svg
            renderVertex(vertexPositionX(i,j), vertexPositionY(i,j), parentEl)
          }
        }
      }


      var gridWidth = 4;
      var gridHeight = 5;
      renderGrid(gridHeight, gridWidth, "renderTarget")

      var cursorToCoords = function(cursor) {
        var x, y
        switch (cursor.vertIdx) {
        case 0:
          x = vertexPositionXTop(cursor.row, cursor.column)
          y = vertexPositionYTop(cursor.row, cursor.column)
          break
        case 1:
          x = vertexPositionXRight(cursor.row, cursor.column)
          y = vertexPositionYRight(cursor.row, cursor.column)
          break
        case 2:
          x = vertexPositionXBottom(cursor.row, cursor.column)
          y = vertexPositionYBottom(cursor.row, cursor.column)
          break
        case 3:
          x = vertexPositionXLeft(cursor.row, cursor.column)
          y = vertexPositionYLeft(cursor.row, cursor.column)
          break
        default:
          console.log("invalid vertIdx " + cursor.vertIdx)
        }

        return { x: x, y: y }
      }

      var renderBing = function(cursor) { // TODO return errors
        var coords0 = cursorToCoords(cursor)
        cursor.vertIdx = (cursor.vertIdx + 1) % 4
        var coords1 = cursorToCoords(cursor)

        var bing = document.createElementNS(svgNS, "path")
        var moves = "M " + coords0.x + " " + coords0.y + " " + "A " + vertexRadius*0.5 + " " + vertexRadius*0.5 + " 0 0 1 " + coords1.x + " " + coords1.y
        bing.setAttributeNS(null, "d", moves)
        bing.setAttributeNS(null, "stroke", "red")
        bing.setAttributeNS(null, "stroke-width", "3")
        cursor.parentEl.appendChild(bing)
        cursor = updateCursorPosition(cursor)

        return cursor
      }

      var renderBong = function(cursor) { // TODO return errors
        var coords0 = cursorToCoords(cursor)
        switch (cursor.vertIdx) {
        case 0: cursor.row -= 1; break;
        case 1: cursor.column += 1; break;
        case 2: cursor.row += 1; break;
        case 3: cursor.column -= 1; break;
        }
        if (cursor.row < 0 || cursor.row >= gridHeight || cursor.column < 0 || cursor.column >= gridWidth) {
          console.log("You're gonna need a bigger grid.")
          return cursor
        }
        cursor.vertIdx = (cursor.vertIdx + 2) % 4

        var coords1 = cursorToCoords(cursor)

        var bong = document.createElementNS(svgNS, "path")
        var moves = "M " + coords0.x + " " + coords0.y + " L " + coords1.x + " " + coords1.y
        bong.setAttributeNS(null, "d", moves)
        bong.setAttributeNS(null, "stroke", "red")
        bong.setAttributeNS(null, "stroke-width", "3")
        cursor.parentEl.appendChild(bong)
        cursor = updateCursorPosition(cursor)
        return cursor
      }

      var updateCursorPosition = function(cursor) {
        var coords = cursorToCoords(cursor)
        cursor.cursorEl.setAttributeNS(null, "cx", coords.x)
        cursor.cursorEl.setAttributeNS(null, "cy", coords.y)
        return cursor
      }

      var cursor = (function(parentId) {
        var c = {
          row: 0,
          column: 0,
          vertIdx: 0, // 0 top, 1 right, 2 bottom, 3 left
          parentEl: document.getElementById(parentId),
        }

        var cursorEl = document.createElementNS(svgNS, "circle")
        cursorEl.setAttributeNS(null, "id", "cursor")
        cursorEl.setAttributeNS(null, "r", pointRadius + 2)
        cursorEl.setAttributeNS(null, "stroke-width", 1)
        cursorEl.setAttributeNS(null, "fill", "none")
        cursorEl.setAttributeNS(null, "stroke", "blue")
        coords = cursorToCoords(c)
        cursorEl.setAttributeNS(null, "cx", coords.x)
        cursorEl.setAttributeNS(null, "cy", coords.y)
        c.cursorEl = cursorEl
        c.parentEl.appendChild(cursorEl)
        return c
      }("renderTarget"))

      var renderTestSequence = function(inp) {
        for (var i=0, l = inp.length; i < l; i++) {
          if(inp[i] === ".") {
            cursor = renderBing(cursor)
          } else if (inp[i] === "-") {
            cursor = renderBong(cursor)
          } else { // TODO add clear character, 'x' perhaps?
            console.log("skipping unknown character '" + inp[i] + "'")
          }
        }
      }
//      renderTestSequence(".-..-...-..-...-..-...-..-..")

      renderSourceEl = document.getElementById("renderSource")
      renderSourceEl.addEventListener("keypress", function(event) {
        switch(event.keyCode || event.charCode) {
        case 45: // -
          cursor = renderBong(cursor)
          break
        case 46: // .
          cursor = renderBing(cursor)
          break
        default:
          renderSourceEl.value = renderSourceEl.value.replace(/[^.-]/, '')
          break
        }
      }, true)



    }, true)
  </script>
